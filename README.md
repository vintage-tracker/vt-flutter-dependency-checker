# Flutter Dependency Checker

GitHub ActionsでFlutterバージョンとパッケージをチェックしてSlackに通知するシンプルなツールです。

## 機能

- Flutter SDKの最新バージョンチェック
- pubspec.yamlから依存パッケージのバージョンチェック
- 更新可能なパッケージの検出（メジャー/マイナー/パッチバージョンで色分け）
- Slackへの通知（Excelファイル付き）

## 重要な前提条件

### Flutterバージョンの取得について

このツールは、チェック対象のFlutterプロジェクトで**FVM（Flutter Version Management）を使用していることを前提**としています。

- **`.fvmrc`ファイルからFlutterバージョンを取得します**
- `.fvmrc`ファイルが存在しない場合は、`pubspec.yaml`の`environment`セクションから取得を試みます
- どちらからも取得できない場合は、最新のFlutterバージョンが表示されます

**推奨**: チェック対象のリポジトリに`.fvmrc`ファイルを配置してください。

`.fvmrc`ファイルの例：
```
flutter: "3.24.0"
```

## セットアップ

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd flutter-version-notification
```

### 2. 依存関係のインストール

```bash
npm install
```

### 3. ビルド

```bash
npm run build
```

### 4. 設定ファイルの作成

`repositories.json.sample`をコピーして`repositories.json`を作成します：

```bash
cp repositories.json.sample repositories.json
```

`repositories.json`を編集して、チェック対象のリポジトリを設定します：

```json
{
  "repositories": [
    {
      "name": "example_app",
      "description": "サンプルFlutterアプリ",
      "url": "https://github.com/your-org/example_app"
    }
  ],
  "settings": {
    "includeDevDeps": true
  }
}
```

**注意**: チェック対象のリポジトリには`.fvmrc`ファイルまたは`pubspec.yaml`にFlutterバージョンが記載されている必要があります。

### 5. Slack Botの作成と設定

#### 5.1. Slack Appの作成

1. [Slack API](https://api.slack.com/apps)にアクセス
2. 「Create New App」をクリック
3. 「From scratch」を選択
4. App名とワークスペースを選択して作成

#### 5.2. Bot Token Scopesの設定

1. 左メニューから「OAuth & Permissions」を選択
2. 「Bot Token Scopes」セクションで以下のスコープを追加：
   - `chat:write` - メッセージ送信
   - `files:write` - ファイルアップロード（Excelファイル添付に必要）

#### 5.3. Botのインストール

1. 「OAuth & Permissions」ページの上部で「Install to Workspace」をクリック
2. 権限を確認して「許可する」をクリック
3. 表示される「Bot User OAuth Token」（`xoxb-`で始まるトークン）をコピー

#### 5.4. Botをチャンネルに招待

通知を送信するSlackチャンネルで以下を実行：

```
/invite @your-bot-name
```

#### 5.5. チャンネルIDの取得

1. SlackのWeb版でチャンネルを開く
2. ブラウザのURLからチャンネルIDを確認
   - 例: `https://your-workspace.slack.com/archives/C0123456789A` → `C0123456789A`

### 6. GitHub Actionsシークレットの設定

GitHubリポジトリで以下のシークレットを設定します：

1. リポジトリの「Settings」を開く
2. 左メニューから「Secrets and variables」→「Actions」を選択
3. 「New repository secret」をクリックして、以下のシークレットを順番に追加：

#### 必須のシークレット

**`SLACK_BOT_TOKEN`**
- 値: Slack Bot User OAuth Token（`xoxb-`で始まるトークン）
- 説明: Slackに通知を送信するために必要

**`SLACK_CHANNEL`**
- 値: SlackチャンネルID（例: `C0123456789A`）
- 説明: 通知を送信するチャンネルID

#### オプションのシークレット

**`GH_TOKEN`**
- 値: GitHub Personal Access Token（`ghp_`で始まるトークン）
- 説明: プライベートリポジトリにアクセスする場合や、レート制限を回避するために必要
- 取得方法:
  1. GitHubの「Settings」→「Developer settings」→「Personal access tokens」→「Tokens (classic)」
  2. 「Generate new token (classic)」をクリック
  3. スコープで`repo`（プライベートリポジトリの場合）または`public_repo`を選択
  4. トークンを生成してコピー

### 7. ワークフローの確認

`.github/workflows/flutter-version-check.yml`が設定済みです。

- **スケジュール実行**: 毎週月曜日 9:00 JST（UTC 0:00）
- **手動実行**: Actionsタブから「Flutter Version & Package Check」ワークフローを選択し、「Run workflow」をクリック

### 8. ローカルでのテスト実行（オプション）

ローカルでテストする場合は、環境変数を設定して実行：

```bash
export SLACK_BOT_TOKEN=xoxb-your-token
export SLACK_CHANNEL=C0123456789A
export GH_TOKEN=ghp_your-token  # オプション
export REPOSITORIES_CONFIG=repositories.json

npm run check
```

## 動作確認

### 初回実行

1. GitHub Actionsの「Actions」タブを開く
2. 「Flutter Version & Package Check」ワークフローを選択
3. 「Run workflow」をクリックして手動実行
4. 実行が完了したら、指定したSlackチャンネルに通知が届くことを確認

### 通知内容

- 総リポジトリ数、成功/失敗数
- Flutter SDK最新版と各リポジトリのFlutterバージョン
- 更新可能なパッケージ一覧（最大5個、残りは「他X個」として表示）
- Excelファイル（スレッドに添付）:
  - 全パッケージの詳細情報
  - メジャーバージョンアップ: 赤色
  - マイナー/パッチバージョンアップ: 青色

### 実際の通知例

#### Slack通知メッセージ

![Slack通知メッセージ](images/slack_report_message.png)

Slackチャンネルに送信される通知メッセージの例です。各リポジトリの更新可能なパッケージ数と主要なパッケージが表示されます。

#### Excelレポート

![Excelレポート](images/slack_report_excell.png)

スレッドに添付されるExcelファイルの例です。リポジトリごとにシートが分かれており、各パッケージの現在のバージョンと最新バージョンが色分けされて表示されます。

## Excelレポートの色分けルール

Excelファイルでは、パッケージの更新状況を色で視覚的に表示します。

### バージョン制約記号（`^`や`~`）について

Flutterの`pubspec.yaml`では、バージョン制約を指定する際に以下の記号を使用します：

- **`^4.8.0`**: `>=4.8.0 <5.0.0`を意味します（4.8.0以上5.0.0未満）
- **`~4.8.0`**: `>=4.8.0 <4.9.0`を意味します（4.8.0以上4.9.0未満）
- **`4.8.0`**: 厳密に4.8.0のみ

**重要なポイント**: `^`記号がある場合、更新は**必須ではありません**が、**更新可能なバージョンがある**ことを示します。

例：`^4.8.0` → `4.9.0`の場合
- `^4.8.0`は`>=4.8.0 <5.0.0`を意味するため、4.9.0はこの範囲内です
- 現在のコードは4.9.0でも動作します（更新不要）
- ただし、4.9.0に更新することも可能です（任意の更新）

### パッケージの色分け

| 色 | 意味 | 説明 | 例 |
|---|---|---|---|
| **黒色（通常）** | 更新不要（任意更新可能） | 現在のバージョン制約の範囲内に最新バージョンが含まれる。更新しなくても動作するが、更新することも可能 | `^4.8.0` → `4.9.0`<br>（`^4.8.0`は`>=4.8.0 <5.0.0`なので、4.9.0を含む） |
| **青色** | マイナー/パッチバージョンアップ | 最新バージョンが現在のバージョン制約の範囲外だが、メジャーバージョンは同じ。比較的安全に更新可能 | `^0.12.0` → `0.14.4`<br>（0.12 → 0.14はマイナーアップ）<br>`^2.1.0` → `2.1.5`<br>（パッチアップ） |
| **赤色** | メジャーバージョンアップ | 最新バージョンのメジャーバージョンが現在より大きい。破壊的変更が含まれる可能性があるため注意が必要 | `^2.2.0` → `3.0.3`<br>（2.x → 3.xはメジャーアップ）<br>`^0.7.2` → `1.0.0`<br>（0.x → 1.xはメジャーアップ） |

### Flutter SDKの色分け

| 色 | 意味 |
|---|---|
| **黒色（通常）** | 最新バージョンを使用中 |
| **オレンジ色** | Flutter SDKの更新が利用可能 |

### 色分けの判定基準

- **黒色（更新不要）**: 現在のバージョン制約（`^`や`~`など）の範囲内に最新バージョンが含まれる場合
  - 例：`^4.8.0`で最新が`4.9.0`の場合、`4.9.0`は`>=4.8.0 <5.0.0`の範囲内なので黒色
  - **注意**: 黒色でも数字が違う場合（例：`^4.8.0` → `4.9.0`）は、更新は必須ではないが、更新可能なバージョンがあることを示します

- **青色（マイナー/パッチアップ）**: 最新バージョンが現在のバージョン制約の範囲外だが、メジャーバージョンは同じ場合
  - 例：`^0.12.0`で最新が`0.14.4`の場合、`0.14.4`は`>=0.12.0 <0.13.0`の範囲外なので青色

- **赤色（メジャーアップ）**: 最新バージョンのメジャーバージョンが現在のバージョンより大きい場合
  - 例：`^2.2.0`で最新が`3.0.3`の場合、メジャーバージョンが2から3に上がっているので赤色

### 特殊なケース

#### パッケージのバージョンが未記載の場合

`pubspec.yaml`でパッケージのバージョンが未記載、または`any`と指定されている場合：

```yaml
dependencies:
  some_package: any  # またはバージョン指定なし
```

- **Excelレポートには表示されません**（スキップされます）
- バージョンチェックができないため、レポートから除外されます
- コンソールには`⏭️  Skipping some_package: version is 'any'`と表示されます

#### 現在のバージョンと最新バージョンが完全に同じ場合

例：`json_annotation: 4.8.0` → `4.8.0`（厳密に同じバージョン）

- **黒色**で表示されます
- 完全に最新バージョンを使用中で、更新の必要はありません

#### 最新バージョンが取得できない場合

パッケージの最新バージョンが取得できない場合（APIエラーなど）：

- 最新バージョン列に`N/A`と表示されます
- **黒色**で表示されます（更新可能かどうか判定できないため）

#### git/path依存関係の場合

`pubspec.yaml`でgitリポジトリやローカルパスを指定している場合：

```yaml
dependencies:
  some_package:
    git:
      url: https://github.com/...
```

- **Excelレポートには表示されません**（スキップされます）
- バージョンチェックができないため、レポートから除外されます

### 具体例

- `json_annotation: ^4.8.0` → `4.9.0` → **黒色**
  - `^4.8.0`は`>=4.8.0 <5.0.0`なので、4.9.0は範囲内
  - 更新は必須ではないが、4.9.0に更新することも可能

- `json_annotation: 4.8.0` → `4.8.0` → **黒色**
  - 現在のバージョンと最新バージョンが完全に同じ
  - 完全に最新で、更新の必要はない

- `flutter_launcher_icons: ^0.12.0` → `0.14.4` → **青色**
  - `^0.12.0`は`>=0.12.0 <0.13.0`なので、0.14.4は範囲外
  - 0.12 → 0.14はマイナーアップ（比較的安全に更新可能）

- `riverpod: ^2.2.0` → `3.0.3` → **赤色**
  - 2.x → 3.xはメジャーアップ
  - 破壊的変更が含まれる可能性があるため、注意が必要

- `some_package: ^1.0.0` → `N/A` → **黒色**
  - 最新バージョンの取得に失敗
  - 更新可能かどうか判定できないため、黒色で表示

## トラブルシューティング

### Flutterバージョンが正しく表示されない

- チェック対象のリポジトリに`.fvmrc`ファイルが存在するか確認
- `.fvmrc`ファイルの形式が正しいか確認（`flutter: "3.24.0"`または`flutter: 3.24.0`）
- `pubspec.yaml`の`environment`セクションにFlutterバージョンが記載されているか確認

### Excelファイルが送信されない

- Slack Botに`files:write`スコープが設定されているか確認
- Botがチャンネルに参加しているか確認（`/invite @your-bot-name`）
- GitHub Actionsのログでエラーメッセージを確認

### プライベートリポジトリにアクセスできない

- `GH_TOKEN`シークレットが設定されているか確認
- GitHub Tokenに`repo`スコープが付与されているか確認

## ライセンス

MIT
